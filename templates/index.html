<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainMaster</title>
    <link rel="stylesheet" href="/static/css/global.css">
</head>

<script src="/static/jquery/jquery.min.js"></script>
<script src="/static/js/global.js"></script>

<body>
    <div class="main">
        <div class="top-bar dragable">
            <div class="left-panel">
                <img src="/static/img/icon.png" class="logo dragable">
                <div class="menu">
                    <div class="item">File
                        <div class="menu-item">
                            <div class="section">
                                <div class="item"><div class="text">New Text File</div><div class="shortcut">Ctrl+N</div></div>
                                <div class="item"><div class="text">New Window</div><div class="shortcut">Ctrl+Shift+N</div></div>
                            </div>
                            <div class="section">
                                <div class="item"><div class="text">Open File...</div><div class="shortcut">Ctrl+O</div></div>
                                <div class="item"><div class="text">Recently Opened</div></div>
                            </div>
                            <div class="section">
                                <div class="item"><div class="text">Save</div><div class="shortcut">Ctrl+S</div></div>
                                <div class="item"><div class="text">Save As...</div><div class="shortcut">Ctrl+Shift+S</div></div>
                            </div>
                            <div class="section">
                                <div class="item"><div class="text">Exit</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="item">Run
                        <div class="menu-item">
                            <div class="item"><div class="text">Start Debugging</div><div class="shortcut">F5</div></div>
                            <div class="item"><div class="text">Run Only</div><div class="shortcut">Ctrl+F5</div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="title-panel dragable"><div class="title dragable">
                MindMaster
            </div></div>
            <div class="right-panel">
                <div class="window-control">
                    <div class="close-btn btn" id="close_btn">
                        <img src="/static/img/close.svg">
                    </div>
                    <div class="maximize-btn btn" id="maximize_btn" style="display: {% if maximize %}flex{% else %}none{% endif %}">
                        <img src="/static/img/maximize.svg">
                    </div>
                    <div class="restore-down-btn btn" id="restore-down_btn" style="display: {% if maximize %}none{% else %}flex{% endif %}">
                        <img src="/static/img/restore-down.svg">
                    </div>
                    <div class="minimize-btn btn" id="minimize_btn">
                        <img src="/static/img/minimize.svg">
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-bar">
            <div class="tab">
                <img src="/static/img/bf-logo.png" class="img">
                <div class="title">hello world.bf</div>
                <div class="close-win-btn btn" id="close_btn">
                    <img src="/static/img/close.svg">
                </div>
            </div>
        </div>
        <div class="editor">
            <div class="window">
                <div class="numbers">
                    <div class="line">1</div>
                    <div class="line selected">2</div>
                    <div class="line">3</div>
                    <div class="line">4</div>
                    <div class="line">5</div>
                    <div class="line">6</div>
                    <div class="line">7</div>
                    <div class="line">8</div>
                    <div class="line">9</div>
                    <div class="line">10</div>
                    <div class="line">11</div>
                    <div class="line">12</div>
                    <div class="line">13</div>
                </div>
                <div class="code">
                    <input type="text" class="line">
                    <input type="text" class="line selected">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                    <input type="text" class="line">
                </div>
            </div>
        </div>
        <div class="home-page">
            <div class="dialog">
                <img src="/static/img/icon.png">
                <h1>MindMaster</h1>
                <a href="#" id="create_tab">create new file</a>
            </div>
        </div>
    </div>
</body>

<script>
    let _ignore_click = false
    let _menu_clicked = false
    let _move_window = false

    let close_program = ()=>{
        $.get("/close")
    }

    let _maximize_window = ()=>{
        $("#maximize_btn").css("display", "none")
        $("#restore-down_btn").css("display", "flex")
    }

    let _minimize_window = ()=>{
        $("#maximize_btn").css("display", "flex")
        $("#restore-down_btn").css("display", "none")
    }

    let maximize_program = ()=>{
        $.get("/maximize")
        _maximize_window()
    }

    let restore_down_program = ()=>{
        $.get("/restore-down")
        _minimize_window()
    }

    let move_program = ()=>{
        _move_window = true
        $.get("/move")
    }

    let unmove_program = ()=>{
        _move_window = false
        $.get("/unmove")
    }

    let show_program = ()=>{
        $.get("/show")
    }

    let minimize_program = ()=>{
        $.get("/minimize")
    }

    $("#close_btn").click(()=>{
        close_program()
    })

    $("#maximize_btn").click(()=>{
        maximize_program()
    })

    $("#restore-down_btn").click(()=>{
        restore_down_program()
    })

    $("#minimize_btn").click(()=>{
        minimize_program()
    })

    $("body").ready(()=>{
        load_home_page()
        show_program()
    })

    let close_topbar_menu = ()=>{
        $(".menu .item")
            .removeClass("clicked")
            .children(".menu-item").css("display", "none");
        _menu_clicked = false;
    }

    $(".menu .item").click((event)=>{
        close_topbar_menu()
        _ignore_click = true
        _menu_clicked = true
        $(event.currentTarget)
            .addClass("clicked")
            .children(".menu-item").css("display", "flex")
    }).hover((event)=>{
        if(!$(event.currentTarget).hasClass("clicked") && _menu_clicked){
            close_topbar_menu()
            $(event.currentTarget).click()
        }
    })

    $(document).click(()=>{
        if(!_ignore_click){
            close_topbar_menu()
        }
        _ignore_click = false
    }).mouseup((event)=>{
        if(event.which === 1 && _move_window){
            unmove_program()
        }
    }).mousedown((event)=>{
        if(event.which === 1 && $(event.target).hasClass("dragable")){
            move_program()
        }
    })

    $("#create_tab").click(()=>{
        create_tab("untitled.bf")
        load_editor_page()
    })

    $(".tab").click((event)=>{
    })

    $(".editor .window .code input.line").click((event)=>{
        deselect_all_lines()
        select_line(_lines().index($(event.currentTarget)))
    }).on("keydown", (e)=>{
        var this_line = $(e.currentTarget)
        if (e.keyCode === 9) {
            e.preventDefault();
            let cursorPos = this_line.prop("selectionStart")
            console.log(cursorPos)
            let v = this_line.val()
            let textBeforeCursor = v.substring(0, cursorPos)
            let textAfterCursor = v.substring(cursorPos, v.length)
            let spacesToAdd = "    "
            let newText = textBeforeCursor + spacesToAdd + textAfterCursor
            this_line.val(newText)
            this_line.prop("selectionStart", cursorPos + spacesToAdd.length)
            this_line.prop("selectionEnd", cursorPos + spacesToAdd.length)
        }else if(e.keyCode === 8){
            let cursorPos = this_line.prop("selectionStart")
            let line_index = _lines().index(this_line)
            console.log(this_line)
            if (cursorPos === this_line.prop("selectionEnd") && cursorPos === 0 && _lines().index(this_line) > 0){
                e.preventDefault();
                let line_data = this_line.val()
                let prev_line_index = _lines().index(this_line)-1
                let prev_line = $(_lines()[prev_line_index])
                remove_line(prev_line_index+1)
                select_line(prev_line_index)
                let prev_line_data = prev_line.val()
                prev_line.val(prev_line_data + line_data)
                console.log(prev_line_data.length)
                prev_line.prop("selectionStart", prev_line_data.length)
                prev_line.prop("selectionEnd", prev_line_data.length)
                prev_line.focus();
            }
        }
    })
</script>

</html>